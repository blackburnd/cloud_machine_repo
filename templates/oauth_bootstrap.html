<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Configuration - Daniel Blackburn</title>
    <link href="/assets/style.css" rel="stylesheet">
</head>
<body class="oauth-page">
    <div class="wrap">
        <div class="fg">
            <!-- Include the navigation component with current page set to 'oauth' -->
            {% with current_page='oauth', user=user_info, user_authenticated=user_authenticated, user_email=user_email %}
                {% include 'navigation.html' %}
            {% endwith %}
            
            <div class="oauth-container">
                <h1>OAuth Configuration</h1>
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="fg">
            <!-- Include the navigation component with current page set to 'oauth_config' -->
            {% with current_page='oauth_config', user=user, user_authenticated=user is not none, user_email=user.email if user else '' %}
                {% include 'navigation.html' %}
            {% endwith %}
            
            <div id="bw" aria-live="polite">
                <div class="container">
                    <h1>OAuth Configuration Setup</h1>
        
        <div id="bootstrap-warning" class="bootstrap-warning">
            <h3>⚠️ Initial System Setup</h3>
            <p>This system is in bootstrap mode. You can configure OAuth settings without authentication.</p>
            <p>Once you link a Google account, authentication will be required for all future OAuth changes.</p>
        </div>
        
        <div class="config-form">
            <h2>LinkedIn OAuth Application</h2>
            
            <div id="status-message" class="status-message hidden"></div>
            
            <form id="oauth-config-form">
                <div class="form-group">
                    <label for="app_name">Application Name:</label>
                    <input type="text" id="app_name" name="app_name" 
                           value="blackburnsystems profile site" required>
                </div>
                
                <div class="form-group">
                    <label for="client_id">Client ID:</label>
                    <input type="text" id="client_id" name="client_id" 
                           placeholder="Your LinkedIn app client ID" required>
                </div>
                
                <div class="form-group">
                    <label for="client_secret">Client Secret:</label>
                    <input type="password" id="client_secret" name="client_secret" 
                           placeholder="Your LinkedIn app client secret" required>
                </div>
                
                <div class="form-group">
                    <label for="redirect_uri">Redirect URI:</label>
                    <input type="url" id="redirect_uri" name="redirect_uri" 
                           value="https://blackburnsystems.com/admin/linkedin/callback" required>
                </div>
                
                <div class="form-group">
                    <label for="scopes">Scopes (comma-separated):</label>
                    <input type="text" id="scopes" name="scopes" 
                           value="r_liteprofile,r_emailaddress" required>
                </div>
                
                <button type="submit" class="btn">Configure LinkedIn OAuth</button>
            </form>
            
            <div id="current-config" class="current-config-section">
                <h3>Current Configuration</h3>
                <div id="config-status">Loading...                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load current configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentConfig();
        });

        // Handle form submission
        document.getElementById('oauth-config-form').addEventListener('submit', function(e) {
            e.preventDefault();
            submitConfig();
        });

        function showMessage(message, type) {
            const messageDiv = document.getElementById('status-message');
            messageDiv.textContent = message;
            messageDiv.className = `status-message ${type}`;
            messageDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        async function loadCurrentConfig() {
            try {
                const response = await fetch('/linkedin/oauth/config');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const configDiv = document.getElementById('config-status');
                    
                    if (data.oauth_app && data.oauth_app.configured) {
                        configDiv.innerHTML = `
                            <p><strong>✅ Configured</strong></p>
                            <p>App Name: ${data.oauth_app.app_name || 'Unknown'}</p>
                            <p>Client ID: ${data.oauth_app.client_id || 'Not set'}</p>
                            <p>Status: ${data.oauth_app.is_active ? 'Active' : 'Inactive'}</p>
                        `;
                        
                        // Pre-fill form with existing values
                        if (data.oauth_app.client_id) {
                            document.getElementById('client_id').value = data.oauth_app.client_id;
                        }
                        if (data.oauth_app.redirect_uri) {
                            document.getElementById('redirect_uri').value = data.oauth_app.redirect_uri;
                        }
                    } else {
                        configDiv.innerHTML = '<p><strong>❌ Not configured</strong></p>';
                    }
                    
                    // Handle bootstrap mode display
                    if (data.bootstrap && !data.bootstrap.is_bootstrap) {
                        document.getElementById('bootstrap-warning').style.display = 'none';
                    }
                } else {
                    document.getElementById('config-status').innerHTML = 
                        `<p class="error-text">Error loading config: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('config-status').innerHTML = 
                    `<p class="error-text">Failed to load configuration: ${error.message}</p>`;
            }
        }

        async function submitConfig() {
            const formData = new FormData(document.getElementById('oauth-config-form'));
            const configData = {
                app_name: formData.get('app_name'),
                client_id: formData.get('client_id'),
                client_secret: formData.get('client_secret'),
                redirect_uri: formData.get('redirect_uri'),
                scopes: formData.get('scopes').split(',').map(s => s.trim())
            };

            try {
                const response = await fetch('/linkedin/oauth/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(configData)
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage('LinkedIn OAuth configured successfully!', 'success');
                    
                    if (data.bootstrap_exit) {
                        showMessage('System is now configured. Future changes will require authentication.', 'success');
                        // Hide bootstrap warning after successful config with real user
                        setTimeout(() => {
                            document.getElementById('bootstrap-warning').style.display = 'none';
                        }, 3000);
                    }
                    
                    // Reload current config to show updated status
                    setTimeout(() => {
                        loadCurrentConfig();
                    }, 1000);
                } else {
                    // Handle error response
                    const errorMessage = data.error || 'Unknown error occurred';
                    console.error('Configuration error:', data);
                    showMessage(`Configuration failed: ${errorMessage}`, 'error');
                }
            } catch (error) {
                console.error('Network/parsing error:', error);
                showMessage(`Failed to configure OAuth: ${error.message}`, 'error');
            }
        }
    </script>
            </div>
        </div>
    </div>
</body>
</html>
