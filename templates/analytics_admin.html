{% extends "base.html" %}

{% block title %}Analytics Dashboard - Daniel Blackburn{% endblock %}

{% block body_class %}analytics-admin claro{% endblock %}

{% block extra_head %}
<script src="/assets/js/analytics-admin.js?v=20250915a"></script>
<link rel="stylesheet" href="{{ url_for('static', path='analytics-admin.css') }}">
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-text">
                <h1>Site Analytics</h1>
                <p class="header-subtitle">Performance metrics and visitor insights</p>
            </div>
        </div>
    </div>

    <!-- Enhanced Stats Section -->
    <div class="analytics-stats-section">
        <div class="analytics-stats">
            <div class="stat-card stat-card-primary">
                <div class="stat-content">
                    <h3>Total Views</h3>
                    <div class="stat-number">{{ analytics.total_views }}</div>
                    <div class="stat-period">Last {{ analytics.period_days }} days</div>
                </div>
            </div>

            <div class="stat-card stat-card-success">
                <div class="stat-content">
                    <h3>Unique Visitors</h3>
                    <div class="stat-number">{{ analytics.unique_visitors }}</div>
                    <div class="stat-period">Last {{ analytics.period_days }} days</div>
                </div>
            </div>

            <div class="stat-card stat-card-info">
                <div class="stat-content">
                    <h3>Human Visitors</h3>
                    <div class="stat-number">{{ analytics.human_visitors }}</div>
                    <div class="stat-period">Last {{ analytics.period_days }} days</div>
                </div>
            </div>

            <div class="stat-card stat-card-warning">
                <div class="stat-content">
                </div>
            </div>
        </div>
            
        <!-- Main Sections Grid -->
        <div class="sections-grid">
            <!-- Enhanced Daily Views section -->
            <div class="analytics-section chart-section">
                <div class="section-header">
                    <h2>Daily Views</h2>
                    <p class="chart-description">Page view trends over time with detailed daily breakdown</p>
                </div>
                <div class="chart-container">
                    <canvas id="dailyViewsChart" width="800" height="400"></canvas>
                </div>
            </div>

            <!-- Enhanced Top Pages Section -->
            <div class="analytics-section table-section">
                <div class="section-header">
                    <h2 class="collapsible-header" onclick="toggleSection('topPages')">
                        <span class="toggle-icon" id="topPagesIcon">â–¼</span>
                        Top Pages
                    </h2>
                    <p class="section-description">Most visited pages ranked by view count</p>
                </div>
                <div id="topPages" class="collapsible-content">
                    <div class="table-wrapper">
                        <table class="analytics-table modern-table">
                            <thead>
                                <tr>
                                    <th>Page</th>
                                    <th>Views</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for page in analytics.top_pages %}
                                <tr>
                                    <td class="page-cell">
                                        <span class="page-path">{{ page.page_path }}</span>
                                    </td>
                                    <td class="views-cell">
                                        <span class="view-count">{{ page.views }}</span>
                                    </td>
                                    <td class="percentage-cell">
                                        <div class="progress-bar">
                                            <div class="progress-fill"
                                                style="width: {{ (page.views / analytics.total_views * 100)|round(1) if analytics.total_views > 0 else 0 }}%">
                                            </div>
                                        </div>
                                        <span class="percentage-text">{{ (page.views / analytics.total_views *
                                            100)|round(1) if analytics.total_views > 0 else 0 }}%</span>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if not analytics.top_pages %}
                                <tr class="no-data-row">
                                    <td colspan="3">
                                        <div class="no-data-message">
                                            <i class="no-data-icon">ðŸ“­</i>
                                            <span>No data available</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Top Referrers Section -->
            <div class="analytics-section table-section">
                <div class="section-header">
                    <h2 class="collapsible-header" onclick="toggleSection('topReferrersContent')">
                        <span class="toggle-icon" id="topReferrersContentIcon">â–¶</span>
                        Top Referrers
                    </h2>
                    <p class="section-description">Most common referrer sources ranked by frequency</p>
                </div>
                <div id="topReferrersContent" class="collapsible-content" style="display: none;">
                    <div id="topReferrersLoading" class="loading-state" style="display: none;">
                        <div class="loading-spinner"></div>
                        <span>Loading referrers...</span>
                    </div>
                    <div id="topReferrersError" class="error-message" style="display: none;"></div>
                    <div class="table-wrapper">
                        <table class="analytics-table modern-table">
                            <thead>
                                <tr>
                                    <th style="text-align: center; width: 60px;">Rank</th>
                                    <th>Referrer</th>
                                    <th style="text-align: center; width: 100px;">Visits</th>
                                    <th style="text-align: center; width: 120px;">Unique Visitors</th>
                                </tr>
                            </thead>
                            <tbody id="topReferrersTableBody">
                                <!-- Data loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Top IP Addresses Section -->
            <div class="analytics-section table-section">
                <div class="section-header">
                    <h2 class="collapsible-header" onclick="toggleSection('topIpsContent')">
                        <span class="toggle-icon" id="topIpsContentIcon">â–¶</span>
                        Top IP Addresses
                    </h2>
                    <p class="section-description">Most active IP addresses ranked by visit count</p>
                </div>
                <div id="topIpsContent" class="collapsible-content" style="display: none;">
                    <div id="topIpsLoading" class="loading-state" style="display: none;">
                        <div class="loading-spinner"></div>
                        <span>Loading IP addresses...</span>
                    </div>
                    <div id="topIpsError" class="error-message" style="display: none;"></div>
                    <div class="table-wrapper">
                        <table class="analytics-table modern-table">
                            <thead>
                                <tr>
                                    <th style="text-align: center; width: 60px;">Rank</th>
                                    <th>IP Address</th>
                                    <th style="text-align: center; width: 100px;">Visits</th>
                                    <th style="text-align: center; width: 120px;">Pages</th>
                                    <th style="text-align: center; width: 100px;">Type</th>
                                    <th style="text-align: center; width: 140px;">Last Visit</th>
                                </tr>
                            </thead>
                            <tbody id="topIpsTableBody">
                                <!-- Data loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </div> <!-- End sections-grid -->
    </div> <!-- End analytics-stats-section -->

<!-- Enhanced Recent Visits section -->
<div class="analytics-section recent-visits-section">
    <div class="section-header">
        <h2>Recent Visits</h2>
        <p class="section-description">Real-time visitor activity and detailed analytics</p>
    </div>

    <div class="visits-controls">
        <div class="controls-row">
            <div class="search-control">
                <input type="text" id="searchBox" placeholder="Search pages, IPs, user agents..."
                    class="modern-input" />
            </div>
            <div class="filter-control">
                <select id="timeFilter" class="modern-select" title="Time Period">
                    <option value="1h">Last Hour</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d" selected>Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
            </div>
            <button id="clearFiltersBtn" style="display: none;" class="clear-btn" onclick="clearFilters()"
                title="Clear Filters">
                <i class="btn-icon">âœ•</i>
            </button>
        </div>

        <div id="searchStatus" class="search-status" style="display: none;"></div>

        <div class="stats-row" id="analyticsStats">
            <div class="stat-badge">
                <span id="totalCount">Total: 0</span>
            </div>
            <div class="stat-badge">
                <span id="filteredVisits">Loaded: 0</span>
            </div>
            <div class="stat-badge clickable-stat" onclick="showUniqueVisitorsPopup()"
                title="Click to view unique visitor details">
                <span id="uniqueVisitors">Unique IPs: 0</span>
            </div>
        </div>
    </div>

    <div class="visits-table-wrapper">
        <div class="table-container">
            <table class="visits-table modern-table">
                <thead>
                    <tr>
                        <th data-sort="timestamp" class="sortable" style="width: 80px;">
                            Date
                            <span class="sort-indicator"></span>
                        </th>
                        <th style="width: 40px;">
                            Age
                        </th>
                        <th data-sort="page_path" class="sortable" style="width: 120px;">
                            Page
                            <span class="sort-indicator"></span>
                        </th>
                        <th data-sort="ip_address" class="sortable" style="width: 90px;">
                            IP Address
                            <span class="sort-indicator"></span>
                        </th>
                        <th data-sort="mouse_activity" class="sortable" style="width: 50px;"
                            title="Human activity detected">
                            Human
                            <span class="sort-indicator"></span>
                        </th>
                        <th data-sort="visitor_type" class="sortable" style="width: 60px;"
                            title="Visitor classification">
                            Type
                            <span class="sort-indicator"></span>
                        </th>
                        <th data-sort="reverse_dns" class="sortable" style="width: 100px;" title="Reverse DNS lookup">
                            DNS
                            <span class="sort-indicator"></span>
                        </th>
                        <th data-sort="is_datacenter" class="sortable" style="width: 40px;" title="Datacenter/Cloud">
                            DC
                            <span class="sort-indicator"></span>
                        </th>
                        <th data-sort="organization" class="sortable" style="width: 80px;" title="Organization/ISP">
                            Org
                            <span class="sort-indicator"></span>
                        </th>
                        <th data-sort="user_agent" class="sortable" style="width: 100px;">
                            User Agent
                            <span class="sort-indicator"></span>
                        </th>
                        <th data-sort="referer" class="sortable" style="width: 80px;">
                            Referer
                            <span class="sort-indicator"></span>
                        </th>
                    </tr>
                </thead>
                <tbody id="analyticsTableBody">
                    <tr>
                        <td colspan="10" class="loading-cell">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <span>Loading visits...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="table-footer">
            <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                <div class="loading-spinner"></div>
                <span>Loading more visits...</span>
            </div>
            <div id="noMoreVisits" class="no-more-indicator" style="display: none;">
                <i class="indicator-icon">âœ“</i>
                <span>All visits loaded</span>
            </div>
            <div id="errorMessage" class="error-indicator" style="display: none;"></div>
            <div id="scrollTrigger" class="scroll-trigger"></div>
        </div>
    </div>
</div>



<!-- Unique Visitors Popup -->
<div id="uniqueVisitorsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Unique Visitors Details</h3>
            <span class="close-button" onclick="closeUniqueVisitorsPopup()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="uniqueVisitorsLoading" class="loading" style="display: none;">Loading visitor details...
            </div>
            <div id="uniqueVisitorsContent">
                <table class="visitors-table">
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Total Views</th>
                            <th>Last Visit</th>
                        </tr>
                    </thead>
                    <tbody id="uniqueVisitorsTableBody">
                        <!-- Content will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize analytics admin page when DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        const dailyViews = {{ analytics.daily_views | tojson
    }};
    initializeAnalyticsAdmin(dailyViews);
            });
</script>

{% endblock %}