{% extends "base.html" %}

{% block title %}Analytics - Daniel Blackburn{% endblock %}

{% block body_class %}analytics-admin claro{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1>Site Analytics</h1>
    
    <div class="analytics-stats">
        <div class="stat-card">
            <h3>Total Views</h3>
            <div class="stat-number">{{ analytics.total_views }}</div>
            <div class="stat-period">Last {{ analytics.period_days }} days</div>
        </div>
        
        <div class="stat-card">
            <h3>Unique Visitors</h3>
            <div class="stat-number">{{ analytics.unique_visitors }}</div>
            <div class="stat-period">Last {{ analytics.period_days }} days</div>
        </div>
    </div>
    
    <div class="analytics-section">
        <h2>Top Pages</h2>
        <table class="analytics-table">
            <thead>
                <tr>
                    <th>Page</th>
                    <th>Views</th>
                </tr>
            </thead>
            <tbody>
                {% for page in analytics.top_pages %}
                <tr>
                    <td>{{ page.page_path }}</td>
                    <td>{{ page.views }}</td>
                </tr>
                {% endfor %}
                {% if not analytics.top_pages %}
                <tr>
                    <td colspan="2">No data available</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <div class="analytics-section">
        <h2>Recent Visits</h2>
        <div class="recent-visits-container">
            <div class="recent-visits-grid" id="recentVisitsGrid">
                <!-- Grid items will be loaded here -->
            </div>
            <div class="loading-indicator" id="loadingIndicator" style="display: none;">
                Loading more visits...
            </div>
            <div class="no-more-data" id="noMoreData" style="display: none;">
                No more visits to load
            </div>
        </div>
    </div>
    
    <div class="analytics-section">
        <h2>Daily Views</h2>
        <div class="chart-container">
            <canvas id="dailyViewsChart" width="800" height="400"></canvas>
        </div>
    </div>
</div>

<script>
// Endless scrolling grid for recent visits
class RecentVisitsGrid {
    constructor() {
        this.currentPage = 1;
        this.isLoading = false;
        this.hasMore = true;
        this.gridContainer = document.getElementById('recentVisitsGrid');
        this.loadingIndicator = document.getElementById('loadingIndicator');
        this.noMoreData = document.getElementById('noMoreData');
        
        this.init();
    }
    
    init() {
        this.loadPage(1);
        this.setupInfiniteScroll();
    }
    
    async loadPage(page) {
        if (this.isLoading || !this.hasMore) return;
        
        this.isLoading = true;
        this.loadingIndicator.style.display = 'block';
        
        try {
            const response = await fetch(`/admin/analytics/recent-visits?page=${page}&page_size=20`);
            const data = await response.json();
            
            if (data.visits && data.visits.length > 0) {
                this.renderVisits(data.visits);
                this.hasMore = data.has_more;
                this.currentPage = page;
            } else {
                this.hasMore = false;
            }
            
            if (!this.hasMore) {
                this.noMoreData.style.display = 'block';
            }
            
        } catch (error) {
            console.error('Error loading visits:', error);
        } finally {
            this.isLoading = false;
            this.loadingIndicator.style.display = 'none';
        }
    }
    
    renderVisits(visits) {
        visits.forEach(visit => {
            const visitCard = document.createElement('div');
            visitCard.className = 'visit-card';
            visitCard.innerHTML = `
                <div class="visit-time">${visit.timestamp}</div>
                <div class="visit-page">${visit.page_path}</div>
                <div class="visit-ip">${visit.ip_address}</div>
                ${visit.user_agent ? `<div class="visit-user-agent">${visit.user_agent}</div>` : ''}
            `;
            this.gridContainer.appendChild(visitCard);
        });
    }
    
    setupInfiniteScroll() {
        window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
                this.loadPage(this.currentPage + 1);
            }
        });
    }
}

// Initialize the recent visits grid
document.addEventListener('DOMContentLoaded', () => {
    new RecentVisitsGrid();
});

// Simple chart for daily views
const canvas = document.getElementById('dailyViewsChart');
const ctx = canvas.getContext('2d');

const dailyViews = {{ analytics.daily_views | tojson }};

if (dailyViews && dailyViews.length > 0) {
    // Simple bar chart
    const maxViews = Math.max(...dailyViews.map(d => d.views));
    const canvasWidth = canvas.width;
    const canvasHeight = canvas.height;
    const barWidth = canvasWidth / dailyViews.length;
    
    ctx.fillStyle = '#007acc';
    
    dailyViews.forEach((day, index) => {
        const barHeight = (day.views / maxViews) * (canvasHeight - 40);
        const x = index * barWidth;
        const y = canvasHeight - barHeight - 20;
        
        ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
        
        // Add date labels
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(day.date, x + barWidth/2, canvasHeight - 5);
        
        // Add view count
        ctx.fillText(day.views, x + barWidth/2, y - 5);
        
        ctx.fillStyle = '#007acc';
    });
} else {
    ctx.fillStyle = '#666';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('No data available', canvas.width/2, canvas.height/2);
}
</script>

<style>
.analytics-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.analytics-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    flex: 1;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    color: #007acc;
    margin: 10px 0;
}

.stat-period {
    color: #666;
    font-size: 0.9em;
}

.analytics-section {
    margin-bottom: 40px;
}

.analytics-section h2 {
    margin-bottom: 15px;
    color: #333;
}

.analytics-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.analytics-table th,
.analytics-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.analytics-table th {
    background: #f5f5f5;
    font-weight: bold;
}

.analytics-table tr:hover {
    background: #f9f9f9;
}

.chart-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
}

#dailyViewsChart {
    border: 1px solid #eee;
}

/* Recent Visits Grid Styles */
.recent-visits-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
}

.recent-visits-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.visit-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 15px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.visit-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.visit-time {
    font-weight: bold;
    color: #007acc;
    font-size: 14px;
    margin-bottom: 8px;
}

.visit-page {
    font-size: 16px;
    color: #333;
    margin-bottom: 5px;
    word-break: break-all;
}

.visit-ip {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
}

.visit-user-agent {
    font-size: 11px;
    color: #888;
    font-style: italic;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.loading-indicator, .no-more-data {
    text-align: center;
    padding: 20px;
    color: #666;
    font-style: italic;
}

@media (max-width: 768px) {
    .recent-visits-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}