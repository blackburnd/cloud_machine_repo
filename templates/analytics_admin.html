{% extends "base.html" %}

{% block title %}Analytics - Daniel Blackburn{% endblock %}

{% block body_class %}analytics-admin claro{% endblock %}

{% block extra_head %}
<script src="/assets/js/analytics-admin.js?v=20250915a"></script>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1>Site Analytics</h1>

    <div class="analytics-content">
        <!-- Stats Section -->
        <div class="analytics-stats-section">
            <h2>Site Analytics</h2>
            <div class="analytics-stats">
                <div class="stat-card">
                    <h3>Total Views</h3>
                    <div class="stat-number">{{ analytics.total_views }}</div>
                    <div class="stat-period">Last {{ analytics.period_days }} days</div>
                </div>

                <div class="stat-card">
                    <h3>Unique Visitors</h3>
                    <div class="stat-number">{{ analytics.unique_visitors }}</div>
                    <div class="stat-period">Last {{ analytics.period_days }} days</div>
                </div>

                <div class="stat-card">
                    <h3>Human Visitors</h3>
                    <div class="stat-number">{{ analytics.human_visitors }}</div>
                    <div class="stat-period">Last {{ analytics.period_days }} days</div>
                </div>

                <!-- Placeholder for 4th stat card to complete 2x2 grid -->
                <div class="stat-card">
                    <h3>Bot Visitors</h3>
                    <div class="stat-number">{{ analytics.bot_visitors }}</div>
                    <div class="stat-period">Last {{ analytics.period_days }} days</div>
                </div>
            </div>
        </div>

        <!-- Top Pages Section -->
        <div class="analytics-pages-section">
            <div class="analytics-section">
                <h2 class="collapsible-header" onclick="toggleSection('topPages')">
                    <span class="toggle-icon" id="topPagesIcon">▼</span>
                    Top Pages
                </h2>
                <div id="topPages" class="collapsible-content">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Page</th>
                                <th>Views</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in analytics.top_pages %}
                            <tr>
                                <td>{{ page.page_path }}</td>
                                <td>{{ page.views }}</td>
                            </tr>
                            {% endfor %}
                            {% if not analytics.top_pages %}
                            <tr>
                                <td colspan="2">No data available</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
 <!-- Daily Views section -->
        <div class="analytics-section">
            <h2>Daily Views</h2>
            <p class="chart-description">Shows the number of page views per day over the selected time period. Each bar
                represents one day's total page views.</p>
            <div class="chart-container">
                <canvas id="dailyViewsChart" width="800" height="400"></canvas>
            </div>
        </div>
        <!-- Recent Visits section - full width outside the grid -->
        <div class="analytics-section full-width-section">
            <h2>Recent Visits</h2>
            <div class="analytics-controls-row compact-controls">
                <input type="text" id="searchBox" placeholder="Search pages, IPs..." class="compact-input" />
                <select id="timeFilter" class="compact-select" title="Time Period">
                    <option value="1h">Last Hour</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d" selected>Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
                <button id="clearFiltersBtn" style="display: none;" class="compact-btn" onclick="clearFilters()"
                    title="Clear">✕</button>
            </div>

            <div id="searchStatus" class="search-status" style="display: none;"></div>

            <div class="analytics-stats compact-stats" id="analyticsStats">
                <span id="totalCount">Total: 0</span>
                <span id="filteredVisits">Loaded: 0</span>
                <span id="uniqueVisitors" class="clickable-stat" onclick="showUniqueVisitorsPopup()"
                    title="Click to view unique visitor details">Unique IPs: 0</span>
            </div>

            <div class="analytics-table-container">
                <table class="analytics-table compact-table">
                    <thead>
                        <tr>
                            <th data-sort="timestamp" class="sortable compact-th" style="width: 120px;">Date <span
                                    class="sort-indicator"></span></th>
                            <th class="compact-th" style="width: 60px;">Age</th>
                            <th data-sort="page_path" class="sortable compact-th" style="width: 200px;">Page <span
                                    class="sort-indicator"></span></th>
                            <th data-sort="ip_address" class="sortable compact-th" style="width: 120px;">IP Address
                                <span class="sort-indicator"></span></th>
                            <th data-sort="mouse_activity" class="sortable compact-th" style="width: 70px;"
                                title="Human activity detected">Human <span class="sort-indicator"></span></th>
                            <th data-sort="visitor_type" class="sortable compact-th" style="width: 80px;"
                                title="Visitor classification">Type <span class="sort-indicator"></span></th>
                            <th data-sort="reverse_dns" class="sortable compact-th" style="width: 150px;"
                                title="Reverse DNS lookup">DNS <span class="sort-indicator"></span></th>
                            <th data-sort="is_datacenter" class="sortable compact-th" style="width: 80px;"
                                title="Datacenter/Cloud">DC <span class="sort-indicator"></span></th>
                            <th data-sort="organization" class="sortable compact-th" style="width: 120px;"
                                title="Organization/ISP">Org <span class="sort-indicator"></span></th>
                            <th data-sort="user_agent" class="sortable compact-th" style="width: 150px;">User Agent
                                <span class="sort-indicator"></span></th>
                            <th data-sort="referer" class="sortable compact-th" style="width: 120px;">Referer <span
                                    class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="analyticsTableBody">
                        <tr>
                            <td colspan="11" class="loading">Loading visits...</td>
                        </tr>
                    </tbody>
                </table>
                <div id="loadingIndicator" class="loading" style="display: none;">Loading more visits...</div>
                <div id="noMoreVisits" class="no-more-logs" style="display: none;">No more visits to load</div>
                <div id="errorMessage" class="error" style="display: none;"></div>
                <div id="scrollTrigger" class="scroll-trigger"></div>
            </div>
        </div>

       

        <!-- Unique Visitors Popup -->
        <div id="uniqueVisitorsModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Unique Visitors Details</h3>
                    <span class="close-button" onclick="closeUniqueVisitorsPopup()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="uniqueVisitorsLoading" class="loading" style="display: none;">Loading visitor details...
                    </div>
                    <div id="uniqueVisitorsContent">
                        <table class="visitors-table">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>Total Views</th>
                                    <th>Last Visit</th>
                                </tr>
                            </thead>
                            <tbody id="uniqueVisitorsTableBody">
                                <!-- Content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Initialize analytics admin page when DOM is ready
            document.addEventListener('DOMContentLoaded', function () {
                const dailyViews = {{ analytics.daily_views | tojson }};
                initializeAnalyticsAdmin(dailyViews);
            });
        </script>

        <style>
            .analytics-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .analytics-stats {
                display: flex;
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                text-align: center;
                flex: 1;
            }

            .stat-number {
                font-size: 2.5em;
                font-weight: bold;
                color: #007acc;
                margin: 10px 0;
            }

            .stat-period {
                color: #666;
                font-size: 0.9em;
            }

            .analytics-section {
                margin-bottom: 40px;
            }

            .analytics-section h2 {
                margin-bottom: 15px;
                color: #333;
            }

            .analytics-table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                overflow: hidden;
            }

            .analytics-table-container {
                border: 1px solid #ccc;
                border-radius: 6px;
                overflow: auto;
                background: #fff;
                height: calc(85vh - var(--header-height, 160px));
                min-height: 400px;
                max-height: 600px;
                width: 100%;
                max-width: 100%;
                margin-bottom: 0;
            }

            .analytics-table th,
            .analytics-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #eee;
            }

            .analytics-table th {
                background: #f5f5f5;
                font-weight: bold;
            }

            .analytics-table tr:hover {
                background: #f9f9f9;
            }

            .chart-container {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
            }

            .chart-description {
                color: #666;
                font-size: 14px;
                margin-bottom: 15px;
                font-style: italic;
            }

            #dailyViewsChart {
                border: 1px solid #eee;
            }

            /* Recent Visits Grid Styles */
            .recent-visits-container {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
            }

            .recent-visits-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .visit-card {
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 6px;
                padding: 15px;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .visit-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .visit-time {
                font-weight: bold;
                color: #007acc;
                font-size: 14px;
                margin-bottom: 8px;
            }

            .visit-page {
                font-size: 16px;
                color: #333;
                margin-bottom: 5px;
                word-break: break-all;
            }

            .visit-ip {
                font-size: 12px;
                color: #666;
                margin-bottom: 5px;
            }

            .visit-user-agent {
                font-size: 11px;
                color: #888;
                font-style: italic;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .loading-indicator,
            .no-more-data {
                text-align: center;
                padding: 20px;
                color: #666;
                font-style: italic;
            }

            @media (max-width: 768px) {
                .recent-visits-grid {
                    grid-template-columns: 1fr;
                }
            }

            /* Collapsible section styles */
            .collapsible-header {
                cursor: pointer;
                user-select: none;
                margin-bottom: 10px;
                transition: color 0.2s ease;
            }

            .collapsible-header:hover {
                color: #007acc;
            }

            .toggle-icon {
                display: inline-block;
                margin-right: 8px;
                font-size: 12px;
                transition: transform 0.2s ease;
            }

            .collapsible-content {
                transition: all 0.3s ease;
            }

            /* Clickable stat styles */
            .clickable-stat {
                cursor: pointer;
                transition: color 0.2s ease;
            }

            .clickable-stat:hover {
                color: #007acc;
                text-decoration: underline;
            }

            /* Modal popup styles */
            .modal {
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
            }

            .modal-content {
                background-color: white;
                margin: 5% auto;
                padding: 0;
                border-radius: 8px;
                width: 80%;
                max-width: 800px;
                max-height: 80vh;
                overflow: hidden;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }

            .modal-header {
                background-color: #f5f5f5;
                padding: 15px 20px;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-header h3 {
                margin: 0;
                color: #333;
            }

            .close-button {
                font-size: 24px;
                font-weight: bold;
                cursor: pointer;
                color: #666;
                transition: color 0.2s ease;
            }

            .close-button:hover {
                color: #000;
            }

            .modal-body {
                padding: 20px;
                max-height: 60vh;
                overflow-y: auto;
            }

            .visitors-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }

            .visitors-table th,
            .visitors-table td {
                padding: 10px;
                text-align: left;
                border-bottom: 1px solid #eee;
            }

            .visitors-table th {
                background-color: #f8f9fa;
                font-weight: bold;
                color: #333;
            }

            .visitors-table tr:hover {
                background-color: #f5f5f5;
            }
        </style>
        {% endblock %}