<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Work Items Admin - Bulk Editor</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        h1 { 
            color: #333; 
            margin-bottom: 30px; 
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .bulk-editor {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .work-item-form {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
            position: relative;
        }
        .work-item-form.new {
            border-color: #28a745;
            background: #f8fff9;
        }
        .work-item-form.updated {
            border-color: #007bff;
            background: #f8f9ff;
        }
        .form-row {
            margin-bottom: 10px;
        }
        .form-row label {
            display: block;
            font-weight: bold;
            margin-bottom: 3px;
            color: #555;
        }
        .form-row input, .form-row textarea, .form-row select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
        }
        .form-row textarea {
            height: 60px;
            resize: vertical;
        }
        .form-actions {
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-remove:hover {
            background: #c82333;
        }
        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .bulk-actions button {
            padding: 12px 24px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        .status-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-info {
            background-color: #cce7ff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        .form-item-counter {
            background: #6c757d;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            top: -10px;
            left: -10px;
        }
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .bulk-actions {
                flex-direction: column;
            }
            .bulk-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Work Items Admin - Bulk Editor</h1>
        
        <div id="statusMessage" class="status-message"></div>
        
        <div class="bulk-actions">
            <button id="loadBtn" class="btn-primary">Load Current Data</button>
            <button id="addItemBtn" class="btn-success">Add New Item</button>
            <button id="saveAllBtn" class="btn-warning">Save All Changes</button>
            <button id="resetBtn" class="btn-danger">Reset Form</button>
        </div>
        
        <div class="bulk-editor">
            <div id="formContainer" class="form-grid">
                <div class="loading">Click "Load Current Data" to begin editing work items</div>
            </div>
        </div>
    </div>

    <script>
        let workItems = [];
        let itemCounter = 0;

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message status-${type}`;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function createWorkItemForm(item = null, isNew = false) {
            const id = item?.id || `new-${++itemCounter}`;
            const formHtml = `
                <div class="work-item-form ${isNew ? 'new' : ''}" data-id="${id}">
                    <div class="form-item-counter">${workItems.length + 1}</div>
                    <div class="form-actions">
                        <button class="btn-remove" onclick="removeWorkItem('${id}')">Ã—</button>
                    </div>
                    
                    <div class="form-row">
                        <label>Company *</label>
                        <input type="text" name="company" value="${item?.company || ''}" required>
                    </div>
                    
                    <div class="form-row">
                        <label>Position *</label>
                        <input type="text" name="position" value="${item?.position || ''}" required>
                    </div>
                    
                    <div class="form-row">
                        <label>Location</label>
                        <input type="text" name="location" value="${item?.location || ''}">
                    </div>
                    
                    <div class="form-row">
                        <label>Start Date *</label>
                        <input type="text" name="start_date" value="${item?.start_date || ''}" 
                               placeholder="YYYY-MM-DD or YYYY" required>
                    </div>
                    
                    <div class="form-row">
                        <label>End Date</label>
                        <input type="text" name="end_date" value="${item?.end_date || ''}" 
                               placeholder="YYYY-MM-DD, YYYY, or leave empty for current">
                    </div>
                    
                    <div class="form-row">
                        <label>Description</label>
                        <textarea name="description">${item?.description || ''}</textarea>
                    </div>
                    
                    <div class="form-row">
                        <label>Company URL</label>
                        <input type="url" name="company_url" value="${item?.company_url || ''}">
                    </div>
                    
                    <div class="form-row">
                        <label>Sort Order</label>
                        <input type="number" name="sort_order" value="${item?.sort_order || 0}">
                    </div>
                    
                    <input type="hidden" name="portfolio_id" value="${item?.portfolio_id || 'daniel-blackburn'}">
                    ${item?.id ? `<input type="hidden" name="id" value="${item.id}">` : ''}
                </div>
            `;
            return formHtml;
        }

        function loadCurrentData() {
            showStatus('Loading work items...', 'info');
            
            fetch('/workitems')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    workItems = data || [];
                    renderForms();
                    showStatus(`Loaded ${workItems.length} work items`, 'success');
                })
                .catch(error => {
                    console.error('Error loading work items:', error);
                    showStatus(`Error loading work items: ${error.message}`, 'error');
                });
        }

        function renderForms() {
            const container = document.getElementById('formContainer');
            
            if (workItems.length === 0) {
                container.innerHTML = '<div class="loading">No work items found. Click "Add New Item" to create your first entry.</div>';
                return;
            }
            
            container.innerHTML = workItems.map(item => createWorkItemForm(item)).join('');
        }

        function addNewItem() {
            const newItem = {
                portfolio_id: 'daniel-blackburn',
                company: '',
                position: '',
                location: '',
                start_date: '',
                end_date: '',
                description: '',
                is_current: false,
                company_url: '',
                sort_order: 0
            };
            
            workItems.push(newItem);
            renderForms();
            showStatus('Added new work item form', 'success');
        }

        function removeWorkItem(id) {
            if (id.startsWith('new-')) {
                // Remove from workItems array for new items
                const index = workItems.findIndex(item => !item.id);
                if (index > -1) {
                    workItems.splice(index, 1);
                }
            } else {
                // Mark existing items for removal
                workItems = workItems.filter(item => item.id !== id);
            }
            
            renderForms();
            showStatus('Removed work item', 'success');
        }

        function collectFormData() {
            const forms = document.querySelectorAll('.work-item-form');
            const formData = [];
            
            forms.forEach(form => {
                const data = {
                    portfolio_id: form.querySelector('[name="portfolio_id"]').value,
                    company: form.querySelector('[name="company"]').value,
                    position: form.querySelector('[name="position"]').value,
                    location: form.querySelector('[name="location"]').value,
                    start_date: form.querySelector('[name="start_date"]').value,
                    end_date: form.querySelector('[name="end_date"]').value || null,
                    description: form.querySelector('[name="description"]').value,
                    company_url: form.querySelector('[name="company_url"]').value || null,
                    sort_order: parseInt(form.querySelector('[name="sort_order"]').value) || 0,
                    is_current: !form.querySelector('[name="end_date"]').value
                };
                
                const idField = form.querySelector('[name="id"]');
                if (idField) {
                    data.id = idField.value;
                }
                
                formData.push(data);
            });
            
            return formData;
        }

        function saveAllChanges() {
            const formData = collectFormData();
            
            if (formData.length === 0) {
                showStatus('No data to save', 'info');
                return;
            }
            
            // Validate required fields
            const missingFields = [];
            formData.forEach((item, index) => {
                if (!item.company || !item.position || !item.start_date) {
                    missingFields.push(`Item ${index + 1}: Missing required fields`);
                }
            });
            
            if (missingFields.length > 0) {
                showStatus(`Validation errors: ${missingFields.join(', ')}`, 'error');
                return;
            }
            
            showStatus('Saving all changes...', 'info');
            
            fetch('/workitems/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ items: formData })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                const { created, updated, errors } = result;
                let message = `Success! Created: ${created.length}, Updated: ${updated.length}`;
                
                if (errors.length > 0) {
                    message += `, Errors: ${errors.length}`;
                    console.error('Bulk operation errors:', errors);
                }
                
                showStatus(message, errors.length > 0 ? 'error' : 'success');
                
                // Reload data to show current state
                setTimeout(loadCurrentData, 1000);
            })
            .catch(error => {
                console.error('Error saving changes:', error);
                showStatus(`Error saving changes: ${error.message}`, 'error');
            });
        }

        function resetForm() {
            if (confirm('Are you sure you want to reset the form? All unsaved changes will be lost.')) {
                workItems = [];
                document.getElementById('formContainer').innerHTML = 
                    '<div class="loading">Click "Load Current Data" to begin editing work items</div>';
                showStatus('Form reset', 'info');
            }
        }

        // Event listeners
        document.getElementById('loadBtn').addEventListener('click', loadCurrentData);
        document.getElementById('addItemBtn').addEventListener('click', addNewItem);
        document.getElementById('saveAllBtn').addEventListener('click', saveAllChanges);
        document.getElementById('resetBtn').addEventListener('click', resetForm);

        // Auto-load data on page load
        document.addEventListener('DOMContentLoaded', loadCurrentData);
    </script>
</body>
</html>
