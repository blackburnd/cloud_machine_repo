<!DOCTYPE html>
<html
    class="no-js wf-freightsanspro-n3-active wf-freightsanspro-n9-active wf-freightsanspro-n4-active wf-freightsanspro-i9-active wf-freightdisplaypro-n7-active wf-freightdisplaypro-i7-active wf-active">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Work Items Bulk Editor - Daniel Blackburn</title>
    <script src="//ajax.googleapis.com/ajax/libs/dojo/1.14.1/dojo/dojo.js"></script>

    <!-- Add consistent CSS styling matching index.html -->
</head>

<body>
    <div class="wrap">
        <header class="site-header">
            <div class="header-top">
                <div class="brand">
                    <a href="/">Daniel Blackburn</a>
                </div>
                <div class="tagline">Software Engineer / Developer</div>
                
                <!-- Authentication Section -->
                <div class="auth-admin-section">
                    <a href="/auth/logout" class="auth-link logout-link">Logout</a>
                    <div class="admin-links">
                        <a href="/workadmin" class="admin-link">Work Admin</a>
                        <a href="/workadmin/bulk" class="admin-link active">Work Bulk</a>
                        <a href="/projectsadmin" class="admin-link">Projects Admin</a>
                        <a href="/projectsadmin/bulk" class="admin-link">Projects Bulk</a>
                        <a href="/linkedin" class="admin-link">LinkedIn Sync</a>
                        <a href="/admin/logs" class="admin-link">Admin Logs</a>
                    </div>
                </div>
            </div>
            
            <nav>
                <!-- Primary Navigation -->
                <ul class="primary-nav">
                    <li><a href="/">Index</a></li>
                    <li><a href="/work">Work</a></li>
                    <li><a href="/contact">Contact</a></li>
                    <li><a href="/resume" target="_blank">Resume</a></li>
                </ul>
                
                <!-- Social Navigation -->
                <ul class="social-nav">
                    <li class="linkedin"><a href="https://www.linkedin.com/in/danielblackburn/">LinkedIn</a></li>
                    <li class="github"><a href="https://github.com/blackburnd">GitHub</a></li>
                    <li class="pypi"><a href="https://pypi.org/user/blackburnd/">PyPI</a></li>
                </ul>
            </nav>
        </header>

        <div class="bulk-editor-content">
            <h2>Work Items - Bulk Editor</h2>
            
            <div id="statusMessage" class="status-message"></div>
            
            <div class="bulk-actions">
                <button id="loadBtn" class="btn-primary">Load Current Data</button>
                <button id="addItemBtn" class="btn-success">Add New Item</button>
                <button id="saveAllBtn" class="btn-warning">Save All Changes</button>
                <button id="resetBtn" class="btn-danger">Reset Form</button>
            </div>
            
            <div class="bulk-editor">
                <div id="formContainer" class="form-grid">
                    <div class="loading">Click "Load Current Data" to begin editing work items</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let workItems = [];
        let itemCounter = 0;

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message status-${type}`;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function createWorkItemForm(item = null, isNew = false) {
            const id = item?.id || `new-${++itemCounter}`;
            const formHtml = `
                <div class="work-item-form ${isNew ? 'new' : ''}" data-id="${id}">
                    <div class="form-item-counter">${workItems.length + 1}</div>
                    <div class="form-actions">
                        <button class="btn-remove" onclick="removeWorkItem('${id}')">Ã—</button>
                    </div>
                    
                    <div class="form-row">
                        <label>Company *</label>
                        <input type="text" name="company" value="${item?.company || ''}" required>
                    </div>
                    
                    <div class="form-row">
                        <label>Position *</label>
                        <input type="text" name="position" value="${item?.position || ''}" required>
                    </div>
                    
                    <div class="form-row">
                        <label>Location</label>
                        <input type="text" name="location" value="${item?.location || ''}">
                    </div>
                    
                    <div class="form-row">
                        <label>Start Date *</label>
                        <input type="text" name="start_date" value="${item?.start_date || ''}" 
                               placeholder="YYYY-MM-DD or YYYY" required>
                    </div>
                    
                    <div class="form-row">
                        <label>End Date</label>
                        <input type="text" name="end_date" value="${item?.end_date || ''}" 
                               placeholder="YYYY-MM-DD, YYYY, or leave empty for current">
                    </div>
                    
                    <div class="form-row">
                        <label>Description</label>
                        <textarea name="description">${item?.description || ''}</textarea>
                    </div>
                    
                    <div class="form-row">
                        <label>Company URL</label>
                        <input type="url" name="company_url" value="${item?.company_url || ''}">
                    </div>
                    
                    <div class="form-row">
                        <label>Sort Order</label>
                        <input type="number" name="sort_order" value="${item?.sort_order || 0}">
                    </div>
                    
                    <input type="hidden" name="portfolio_id" value="${item?.portfolio_id || 'daniel-blackburn'}">
                    ${item?.id ? `<input type="hidden" name="id" value="${item.id}">` : ''}
                </div>
            `;
            return formHtml;
        }

        function loadCurrentData() {
            showStatus('Loading work items...', 'info');
            
            fetch('/workitems')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    workItems = data || [];
                    renderForms();
                    showStatus(`Loaded ${workItems.length} work items`, 'success');
                })
                .catch(error => {
                    console.error('Error loading work items:', error);
                    showStatus(`Error loading work items: ${error.message}`, 'error');
                });
        }

        function renderForms() {
            const container = document.getElementById('formContainer');
            
            if (workItems.length === 0) {
                container.innerHTML = '<div class="loading">No work items found. Click "Add New Item" to create your first entry.</div>';
                return;
            }
            
            container.innerHTML = workItems.map(item => createWorkItemForm(item)).join('');
        }

        function addNewItem() {
            const newItem = {
                portfolio_id: 'daniel-blackburn',
                company: '',
                position: '',
                location: '',
                start_date: '',
                end_date: '',
                description: '',
                is_current: false,
                company_url: '',
                sort_order: 0
            };
            
            workItems.push(newItem);
            renderForms();
            showStatus('Added new work item form', 'success');
        }

        function removeWorkItem(id) {
            if (id.startsWith('new-')) {
                // Remove from workItems array for new items
                const index = workItems.findIndex(item => !item.id);
                if (index > -1) {
                    workItems.splice(index, 1);
                }
            } else {
                // Mark existing items for removal
                workItems = workItems.filter(item => item.id !== id);
            }
            
            renderForms();
            showStatus('Removed work item', 'success');
        }

        function collectFormData() {
            const forms = document.querySelectorAll('.work-item-form');
            const formData = [];
            
            forms.forEach(form => {
                const data = {
                    portfolio_id: form.querySelector('[name="portfolio_id"]').value,
                    company: form.querySelector('[name="company"]').value,
                    position: form.querySelector('[name="position"]').value,
                    location: form.querySelector('[name="location"]').value,
                    start_date: form.querySelector('[name="start_date"]').value,
                    end_date: form.querySelector('[name="end_date"]').value || null,
                    description: form.querySelector('[name="description"]').value,
                    company_url: form.querySelector('[name="company_url"]').value || null,
                    sort_order: parseInt(form.querySelector('[name="sort_order"]').value) || 0,
                    is_current: !form.querySelector('[name="end_date"]').value
                };
                
                const idField = form.querySelector('[name="id"]');
                if (idField) {
                    data.id = idField.value;
                }
                
                formData.push(data);
            });
            
            return formData;
        }

        function saveAllChanges() {
            const formData = collectFormData();
            
            if (formData.length === 0) {
                showStatus('No data to save', 'info');
                return;
            }
            
            // Validate required fields
            const missingFields = [];
            formData.forEach((item, index) => {
                if (!item.company || !item.position || !item.start_date) {
                    missingFields.push(`Item ${index + 1}: Missing required fields`);
                }
            });
            
            if (missingFields.length > 0) {
                showStatus(`Validation errors: ${missingFields.join(', ')}`, 'error');
                return;
            }
            
            showStatus('Saving all changes...', 'info');
            
            fetch('/workitems/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ items: formData })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                const { created, updated, errors } = result;
                let message = `Success! Created: ${created.length}, Updated: ${updated.length}`;
                
                if (errors.length > 0) {
                    message += `, Errors: ${errors.length}`;
                    console.error('Bulk operation errors:', errors);
                }
                
                showStatus(message, errors.length > 0 ? 'error' : 'success');
                
                // Reload data to show current state
                setTimeout(loadCurrentData, 1000);
            })
            .catch(error => {
                console.error('Error saving changes:', error);
                showStatus(`Error saving changes: ${error.message}`, 'error');
            });
        }

        function resetForm() {
            if (confirm('Are you sure you want to reset the form? All unsaved changes will be lost.')) {
                workItems = [];
                document.getElementById('formContainer').innerHTML = 
                    '<div class="loading">Click "Load Current Data" to begin editing work items</div>';
                showStatus('Form reset', 'info');
            }
        }

        // Event listeners
        document.getElementById('loadBtn').addEventListener('click', loadCurrentData);
        document.getElementById('addItemBtn').addEventListener('click', addNewItem);
        document.getElementById('saveAllBtn').addEventListener('click', saveAllChanges);
        document.getElementById('resetBtn').addEventListener('click', resetForm);

        // Auto-load data on page load
        document.addEventListener('DOMContentLoaded', loadCurrentData);
    </script>
</body>
</html>
