<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Projects Admin</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 30px; }
        .content-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px; }
        #grid { width: 100%; margin-bottom: 20px; }
        #grid table { width: 100%; border-collapse: collapse; }
        #grid th, #grid td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        #grid th { background-color: #f8f9fa; font-weight: bold; }
        #grid tr:nth-child(even) { background-color: #f9f9f9; }
        .crud-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .crud-buttons button { padding: 12px 24px; font-size: 14px; cursor: pointer; border: none; border-radius: 4px; }
        #addBtn { background-color: #28a745; color: white; }
        #addBtn:hover { background-color: #218838; }
        #deleteBtn { background-color: #dc3545; color: white; }
        #deleteBtn:hover { background-color: #c82333; }
        .loading { color: #666; font-style: italic; padding: 20px; }
        .error { color: red; padding: 20px; }
        input[type="checkbox"] { cursor: pointer; }
        .tech-tags { font-size: 0.85em; }
        .tech-tag { background: #e9ecef; padding: 2px 6px; border-radius: 3px; margin: 1px; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        {% include 'navigation.html' %}
        
        <div class="content-section">
            <h1>Projects Admin</h1>
            <div id="grid">Loading projects...</div>
            <div class="crud-buttons">
                <button id="addBtn">Add Project</button>
                <button id="deleteBtn">Delete Selected</button>
            </div>
        </div>
    </div>
    <script>
        // Use standard JavaScript for better compatibility
        document.addEventListener('DOMContentLoaded', function() {
            function loadGrid() {
                document.getElementById('grid').innerHTML = '<div class="loading">Loading projects...</div>';
                
                fetch('/projects')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Loaded projects:", data);
                        let gridHtml = '<table><tr>' +
                            '<th>Select</th><th>Title</th><th>Description</th><th>URL</th><th>Technologies</th></tr>';
                        
                        if (data && data.length > 0) {
                            data.forEach(function(item) {
                                const techTags = (item.technologies || []).map(tech => 
                                    `<span class="tech-tag">${tech}</span>`
                                ).join(' ');
                                
                                gridHtml += '<tr data-id="' + item.id + '">' +
                                    '<td><input type="checkbox" class="select-row"></td>' +
                                    '<td>' + (item.title || '') + '</td>' +
                                    '<td>' + (item.description || '').substring(0, 100) + (item.description && item.description.length > 100 ? '...' : '') + '</td>' +
                                    '<td>' + (item.url ? `<a href="${item.url}" target="_blank">View</a>` : '-') + '</td>' +
                                    '<td class="tech-tags">' + techTags + '</td>' +
                                    '</tr>';
                            });
                        } else {
                            gridHtml += '<tr><td colspan="5">No projects found</td></tr>';
                        }
                        gridHtml += '</table>';
                        document.getElementById('grid').innerHTML = gridHtml;
                    })
                    .catch(error => {
                        console.error("Error loading projects:", error);
                        document.getElementById('grid').innerHTML = '<div class="error">Error loading projects: ' + error.message + '</div>';
                    });
            }
            
            function addProject() {
                const title = prompt("Project Title:");
                const description = prompt("Description:");
                const url = prompt("Project URL (optional):");
                const imageUrl = prompt("Image URL (optional):");
                const techInput = prompt("Technologies (comma separated):");
                const sortOrder = prompt("Sort Order (number):");
                
                if (title && description) {
                    const technologies = techInput ? techInput.split(',').map(t => t.trim()).filter(t => t) : [];
                    
                    const newProject = {
                        portfolio_id: "daniel-blackburn",
                        title: title,
                        description: description,
                        url: url || null,
                        image_url: imageUrl || null,
                        technologies: technologies,
                        sort_order: parseInt(sortOrder) || 0
                    };
                    
                    fetch('/projects', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newProject)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Project added:", data);
                        loadGrid(); // Reload the grid
                    })
                    .catch(error => {
                        console.error("Error adding project:", error);
                        alert("Error adding project: " + error.message);
                    });
                }
            }
            
            function deleteSelected() {
                const checkboxes = document.querySelectorAll('.select-row:checked');
                if (checkboxes.length === 0) {
                    alert("Please select projects to delete");
                    return;
                }
                
                if (!confirm(`Are you sure you want to delete ${checkboxes.length} project(s)?`)) {
                    return;
                }
                
                const idsToDelete = Array.from(checkboxes).map(cb => {
                    return cb.closest('tr').getAttribute('data-id');
                });
                
                // Delete each item individually
                Promise.all(idsToDelete.map(id => 
                    fetch(`/projects/${id}`, { method: 'DELETE' })
                )).then(responses => {
                    console.log("Delete responses:", responses);
                    loadGrid(); // Reload the grid
                }).catch(error => {
                    console.error("Error deleting projects:", error);
                    alert("Error deleting projects: " + error.message);
                });
            }
            
            // Add event listeners
            document.getElementById('addBtn').addEventListener('click', addProject);
            document.getElementById('deleteBtn').addEventListener('click', deleteSelected);
            
            // Load initial data
            loadGrid();
        });
    </script>
</body>
</html>
