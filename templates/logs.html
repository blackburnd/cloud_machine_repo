<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Logs - Admin</title>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/dojo/1.17.3/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="/templates/style.css">
    <script>
        // Configure Dojo before loading
        var dojoConfig = {
            async: true,
            parseOnLoad: false,
            baseUrl: "https://ajax.googleapis.com/ajax/libs/dojo/1.17.3/",
            packages: [
                {
                    name: "dgrid",
                    location: "https://cdn.jsdelivr.net/npm/dgrid@1.3.3/",
                    main: "Grid"
                }
            ]
        };
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/dojo/1.17.3/dojo/dojo.js"></script>
</head>
<body class="claro logs">
    <!-- Include the navigation component with current page set to 'logs' -->
    {% with current_page='logs', user=user_info, user_authenticated=user_authenticated, user_email=user_email %}
        {% include 'navigation.html' %}
    {% endwith %}
    
    <div class="container">
        <div class="header">
            <h1>üîç Application Logs</h1>
            <div class="controls">
                <input type="text" id="searchBox" placeholder="Search logs..." />
                <button onclick="refreshLogs()">üîÑ Refresh</button>
                <button onclick="clearLogs()">üóëÔ∏è Clear</button>
                <a href="/workadmin" style="color: white; text-decoration: none;">‚Üê Back to Admin</a>
            </div>
        </div>
        
        <div class="filter-bar">
            <div class="filter-group">
                <label>Level:</label>
                <select id="levelFilter">
                    <option value="">All Levels</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                    <option value="CRITICAL">CRITICAL</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Source:</label>
                <select id="sourceFilter">
                    <option value="">All Sources</option>
                    <option value="auth">auth.py</option>
                    <option value="main">main.py</option>
                    <option value="uvicorn">uvicorn</option>
                    <option value="oauth">OAuth</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Time Range:</label>
                <select id="timeFilter">
                    <option value="60">Last Hour</option>
                    <option value="300">Last 5 Minutes</option>
                    <option value="1440">Last 24 Hours</option>
                    <option value="">All Time</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Auto Refresh:</label>
                <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()" />
                <span id="autoRefreshStatus">Off</span>
            </div>
        </div>
        
        <div id="logGrid" class="log-grid"></div>
        
        <div class="stats">
            <div>
                <span id="totalLogs">Total: 0</span> | 
                <span id="filteredLogs">Showing: 0</span> | 
                <span id="lastUpdate">Last Update: Never</span>
            </div>
            <div>
                <span id="errorCount">Errors: 0</span> | 
                <span id="warningCount">Warnings: 0</span>
            </div>
        </div>
    </div>

    <script>
        // Improved error handling and module loading
        function initializeLogs() {
            if (typeof require === 'undefined') {
                console.error('Dojo require function is not available.');
                document.getElementById('logGrid').innerHTML = '<div style="color: red; padding: 20px; text-align: center;"><h3>Error: Dojo Framework Failed to Load</h3><p>Please refresh the page or check your internet connection.</p></div>';
                return;
            }

            console.log('Dojo loaded successfully, initializing logs interface...');

            require([
                "dojo/ready",
                "dgrid/Grid",
                "dgrid/Keyboard", 
                "dgrid/Selection",
                "dgrid/extensions/Pagination",
                "dojo/store/Memory",
                "dojo/store/Observable",
                "dojo/dom",
                "dojo/dom-construct",
                "dojo/on",
                "dojo/query",
                "dojo/_base/declare"
            ], function(ready, Grid, Keyboard, Selection, Pagination, Memory, Observable, dom, domConstruct, on, query, declare) {
            
            let grid;
            let store;
            let autoRefreshInterval;
            let allLogs = [];
            
            ready(function() {
                initializeGrid();
                loadLogs();
                setupEventListeners();
            });
            
            function initializeGrid() {
                // Create store
                store = new Observable(new Memory({
                    data: [],
                    idProperty: "id"
                }));
                
                // Create grid with columns
                const GridClass = declare([Grid, Keyboard, Selection, Pagination]);
                grid = new GridClass({
                    store: store,
                    columns: {
                        timestamp: {
                            label: "Time",
                            width: "150px",
                            formatter: function(value) {
                                return new Date(value).toLocaleString();
                            }
                        },
                        level: {
                            label: "Level",
                            width: "80px",
                            formatter: function(value, row) {
                                return '<span class="log-level-' + value + '">' + value + '</span>';
                            }
                        },
                        source: {
                            label: "Source",
                            width: "100px"
                        },
                        message: {
                            label: "Message",
                            width: "auto",
                            formatter: function(value) {
                                return '<div class="log-message">' + escapeHtml(value) + '</div>';
                            }
                        }
                    },
                    rowsPerPage: 50,
                    pagingLinks: true,
                    pagingTextBox: true,
                    firstLastArrows: true
                }, "logGrid");
                
                grid.startup();
            }
            
            async function loadLogs() {
                try {
                    const response = await fetch('/debug/logs/data');
                    const data = await response.json();
                    
                    allLogs = data.logs || [];
                    updateStats(data.stats || {});
                    applyFilters();
                    
                    dom.byId('lastUpdate').textContent = 'Last Update: ' + new Date().toLocaleString();
                } catch (error) {
                    console.error('Failed to load logs:', error);
                }
            }
            
            function applyFilters() {
                const searchTerm = dom.byId('searchBox').value.toLowerCase();
                const levelFilter = dom.byId('levelFilter').value;
                const sourceFilter = dom.byId('sourceFilter').value;
                const timeFilter = dom.byId('timeFilter').value;
                
                let filteredLogs = allLogs.filter(log => {
                    // Search filter
                    if (searchTerm && !log.message.toLowerCase().includes(searchTerm)) {
                        return false;
                    }
                    
                    // Level filter
                    if (levelFilter && log.level !== levelFilter) {
                        return false;
                    }
                    
                    // Source filter
                    if (sourceFilter && !log.source.includes(sourceFilter)) {
                        return false;
                    }
                    
                    // Time filter
                    if (timeFilter) {
                        const cutoff = new Date(Date.now() - timeFilter * 60 * 1000);
                        if (new Date(log.timestamp) < cutoff) {
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                // Sort by timestamp (newest first)
                filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Update store
                store.setData(filteredLogs.map((log, index) => ({
                    id: index,
                    ...log
                })));
                
                dom.byId('filteredLogs').textContent = 'Showing: ' + filteredLogs.length;
            }
            
            function updateStats(stats) {
                dom.byId('totalLogs').textContent = 'Total: ' + (stats.total || 0);
                dom.byId('errorCount').textContent = 'Errors: ' + (stats.errors || 0);
                dom.byId('warningCount').textContent = 'Warnings: ' + (stats.warnings || 0);
            }
            
            function setupEventListeners() {
                // Search box
                on(dom.byId('searchBox'), 'keyup', function() {
                    applyFilters();
                });
                
                // Filter dropdowns
                on(dom.byId('levelFilter'), 'change', applyFilters);
                on(dom.byId('sourceFilter'), 'change', applyFilters);
                on(dom.byId('timeFilter'), 'change', applyFilters);
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Global functions
            window.refreshLogs = loadLogs;
            
            window.clearLogs = async function() {
                if (confirm('Are you sure you want to clear all logs?')) {
                    try {
                        await fetch('/debug/logs/clear', { method: 'POST' });
                        loadLogs();
                    } catch (error) {
                        alert('Failed to clear logs: ' + error.message);
                    }
                }
            };
            
            window.toggleAutoRefresh = function() {
                const checkbox = dom.byId('autoRefresh');
                const status = dom.byId('autoRefreshStatus');
                
                if (checkbox.checked) {
                    autoRefreshInterval = setInterval(loadLogs, 5000); // Refresh every 5 seconds
                    status.textContent = 'On (5s)';
                } else {
                    clearInterval(autoRefreshInterval);
                    status.textContent = 'Off';
                }
            };
        }, function(error) {
            console.error('Failed to load Dojo modules:', error);
            document.getElementById('logGrid').innerHTML = '<div style="color: red; padding: 20px; text-align: center;"><h3>Error: Failed to Load Required Modules</h3><p>Could not load dgrid or other required components. Please refresh the page.</p><p>Error: ' + error.message + '</p></div>';
        });
        }

        // Initialize when DOM is ready
        function waitForDojo() {
            if (typeof require !== 'undefined' && typeof dojo !== 'undefined') {
                initializeLogs();
            } else {
                setTimeout(waitForDojo, 100); // Check again in 100ms
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForDojo);
        } else {
            waitForDojo();
        }
    </script>
</body>
</html>