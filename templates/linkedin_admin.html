<!DOCTYPE html>
<html
    class="no-js wf-freightsanspro-n3-active wf-freightsanspro-n9-active wf-freightsanspro-n4-active wf-freightsanspro-i9-active wf-freightdisplaypro-n7-active wf-freightdisplaypro-i7-active wf-active">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LinkedIn Sync Admin - Daniel Blackburn</title>
    <script src="//ajax.googleapis.com/ajax/libs/dojo/1.14.1/dojo/dojo.js"></script>
    <link rel="stylesheet" href="/assets/style.css">
</head>

<body class="linkedin-admin">
    <div class="wrap">
        <div class="fg">
            <!-- Include the navigation component with current page set to 'linkedin' -->
            {% with current_page='linkedin', user=user_info, user_authenticated=user_authenticated, user_email=user_email %}
                {% include 'navigation.html' %}
            {% endwith %}
            
            <div class="linkedin-admin-content">
                <h1>LinkedIn Sync Administration</h1>
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .sync-buttons button:hover {
            background: #0056b3;
        }
        
        .sync-buttons button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .result-message {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .result-message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result-message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .sync-history {
            margin-top: 20px;
        }
        
        .sync-history-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>

<body class="me">
    <div class="wrap">
        <div class="fg">
            <header class="site-header" id="h">
                <div class="header-top">
                    <div class="brand">
                        <a href="/">Daniel Blackburn</a>
                    </div>
                    <div class="tagline">Software Engineer / Developer</div>
                    
                    <!-- Authentication Section -->
                    <div class="auth-admin-section">
                        <a href="/auth/logout" class="auth-link logout-link">Logout</a>
                        <div class="admin-links">
                            <a href="/workadmin" class="admin-link">Work Admin</a>
                            <a href="/workadmin/bulk" class="admin-link">Work Bulk</a>
                            <a href="/projectsadmin" class="admin-link">Projects Admin</a>
                            <a href="/projectsadmin/bulk" class="admin-link">Projects Bulk</a>
                            <a href="/linkedin" class="admin-link active">LinkedIn Sync</a>
                            <a href="/admin/logs" class="admin-link">Admin Logs</a>
                        </div>
                    </div>
                </div>
                
                <nav>
                    <!-- Primary Navigation -->
                    <ul class="primary-nav">
                        <li><a href="/">Index</a></li>
                        <li><a href="/work">Work</a></li>
                        <li><a href="/contact">Contact</a></li>
                        <li><a href="/resume" target="_blank">Resume</a></li>
                    </ul>
                    
                    <!-- Social Navigation -->
                    <ul class="social-nav">
                        <li class="linkedin"><a href="https://www.linkedin.com/in/danielblackburn/">LinkedIn</a></li>
                        <li class="github"><a href="https://github.com/blackburnd">GitHub</a></li>
                        <li class="pypi"><a href="https://pypi.org/user/blackburnd/">PyPI</a></li>
                    </ul>
                </nav>
            </header>
            
            <div id="bw" aria-live="polite">
                <div class="linkedin-admin-content">
                    <h2>üîó LinkedIn Sync Administration</h2>
                    
                    <!-- LinkedIn Connection Status -->
                    <div class="connection-section">
                        <h3>LinkedIn Connection</h3>
                        <div id="connectionStatus">Loading connection status...</div>
                        <div id="connectionActions" class="hidden">
                            <button id="connectLinkedInBtn" onclick="connectLinkedIn()" class="hidden">Connect LinkedIn</button>
                            <button id="disconnectLinkedInBtn" onclick="disconnectLinkedIn()" class="hidden">Disconnect LinkedIn</button>
                        </div>
                    </div>

                    <!-- Sync Controls (only shown when LinkedIn is connected) -->
                    <div id="syncControls" class="hidden">
                        <div class="sync-section">
                            <h3>Profile Sync</h3>
                            <p>Sync basic profile information from LinkedIn to your portfolio.</p>
                            <div class="sync-buttons">
                                <button id="syncProfileBtn" onclick="syncProfile()">Sync Profile</button>
                            </div>
                        </div>

                        <div class="sync-section">
                            <h3>Experience Sync</h3>
                            <p>Sync work experience and professional history from LinkedIn.</p>
                            <div class="sync-buttons">
                                <button id="syncExperienceBtn" onclick="syncExperience()">Sync Experience</button>
                            </div>
                        </div>

                        <div class="sync-section">
                            <h3>Full Sync</h3>
                            <p>Perform a complete sync of all available LinkedIn data.</p>
                            <div class="sync-buttons">
                                <button id="syncAllBtn" onclick="syncAll()">Full Sync</button>
                            </div>
                        </div>

                        <div class="sync-section">
                            <h3>Sync History</h3>
                            <div id="syncHistory">Loading sync history...</div>
                        </div>
                    </div>

                    <!-- Results Display -->
                    <div id="resultMessages"></div>
                </div>
            </div>
            
            <footer class="footer" role="contentinfo">
                <p class="copyright">¬© 2025 Blackburn.</p>
            </footer>
        </div>
    </div>

    <script>
        // Global state
        let linkedinConnected = false;
        let syncInProgress = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadConnectionStatus();
            loadSyncHistory();
        });

        // Load LinkedIn connection status
        async function loadConnectionStatus() {
            try {
                const response = await fetch('/linkedin/status', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.status === 'success') {
                    updateConnectionUI(data.linkedin_sync);
                } else {
                    showError('Failed to load LinkedIn status: ' + data.error);
                }

            } catch (error) {
                console.error('Error loading LinkedIn status:', error);
                showError('Error loading LinkedIn status: ' + error.message);
            }
        }

        // Update connection UI based on status
        function updateConnectionUI(status) {
            const connectionStatus = document.getElementById('connectionStatus');
            const connectionActions = document.getElementById('connectionActions');
            const connectBtn = document.getElementById('connectLinkedInBtn');
            const disconnectBtn = document.getElementById('disconnectLinkedInBtn');
            const syncControls = document.getElementById('syncControls');

            linkedinConnected = status.connected;

            if (status.connected) {
                connectionStatus.innerHTML = `
                    <div class="connection-status connected">
                        <strong>‚úÖ LinkedIn Connected</strong><br>
                        Profile: ${status.profile_name || 'N/A'}<br>
                        LinkedIn ID: ${status.linkedin_profile_id || 'N/A'}<br>
                        Token expires: ${status.expires_at ? new Date(status.expires_at).toLocaleString() : 'N/A'}<br>
                        Last sync: ${status.last_sync ? new Date(status.last_sync).toLocaleString() : 'Never'}
                    </div>
                `;
                
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
                syncControls.classList.remove('hidden');

            } else {
                connectionStatus.innerHTML = `
                    <div class="connection-status disconnected">
                        <strong>‚ùå LinkedIn Not Connected</strong><br>
                        ${status.message || 'Connect your LinkedIn account to enable data sync.'}
                    </div>
                `;
                
                connectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('hidden');
                syncControls.classList.add('hidden');
            }

            connectionActions.classList.remove('hidden');
        }

        // Load sync history
        async function loadSyncHistory() {
            if (!linkedinConnected) {
                return;
            }

            try {
                const response = await fetch('/linkedin/sync/history', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        updateSyncHistoryUI(data.history);
                    }
                }
            } catch (error) {
                console.error('Error loading sync history:', error);
            }
        }

        // Update sync history UI
        function updateSyncHistoryUI(history) {
            const syncHistory = document.getElementById('syncHistory');
            
            if (!history || history.length === 0) {
                syncHistory.innerHTML = '<p>No sync history available.</p>';
                return;
            }

            const historyHTML = history.map(item => `
                <div class="sync-history-item">
                    <strong>${item.type}</strong> - ${item.status}<br>
                    <small>${new Date(item.timestamp).toLocaleString()}</small>
                </div>
            `).join('');

            syncHistory.innerHTML = historyHTML;
        }

        // Connect LinkedIn
        async function connectLinkedIn() {
            try {
                const response = await fetch('/linkedin/oauth/authorize', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.status === 'success') {
                    // Redirect to LinkedIn authorization
                    window.location.href = data.authorization_url;
                } else {
                    showError('Failed to initiate LinkedIn connection: ' + data.error);
                }

            } catch (error) {
                console.error('Error connecting LinkedIn:', error);
                showError('Error connecting to LinkedIn: ' + error.message);
            }
        }

        // Disconnect LinkedIn
        async function disconnectLinkedIn() {
            if (!confirm('Are you sure you want to disconnect your LinkedIn account?')) {
                return;
            }

            try {
                const response = await fetch('/linkedin/oauth/disconnect', {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.status === 'success') {
                    showSuccess('LinkedIn account disconnected successfully');
                    // Reload status
                    loadConnectionStatus();
                } else {
                    showError('Failed to disconnect LinkedIn: ' + data.error);
                }

            } catch (error) {
                console.error('Error disconnecting LinkedIn:', error);
                showError('Error disconnecting LinkedIn: ' + error.message);
            }
        }

        // Sync functions
        async function syncProfile() {
            await performSync('profile', 'syncProfileBtn');
        }

        async function syncExperience() {
            await performSync('experience', 'syncExperienceBtn');
        }

        async function syncAll() {
            await performSync('full', 'syncAllBtn');
        }

        // Perform sync operation
        async function performSync(type, buttonId) {
            if (!linkedinConnected) {
                showError('LinkedIn account not connected. Please connect your LinkedIn account first.');
                return;
            }

            if (syncInProgress) {
                showError('Sync already in progress. Please wait.');
                return;
            }

            syncInProgress = true;
            const button = document.getElementById(buttonId);
            const originalText = button.textContent;

            try {
                // Update UI for loading state
                button.disabled = true;
                button.textContent = 'Syncing...';

                const response = await fetch(`/linkedin/sync/${type}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    showSuccess(`${type} sync completed successfully!`, data.result);
                    // Reload sync history
                    loadSyncHistory();
                } else {
                    showError(data.error || `${type} sync failed`);
                }

            } catch (error) {
                console.error('Sync error:', error);
                showError(`Network error during ${type} sync: ${error.message}`);
            } finally {
                // Restore button state
                button.disabled = false;
                button.textContent = originalText;
                syncInProgress = false;
            }
        }

        // Show success message
        function showSuccess(message, data) {
            clearMessages();
            const resultMessages = document.getElementById('resultMessages');
            
            let dataHTML = '';
            if (data) {
                dataHTML = `
                    <details class="debug-details">
                        <summary>Sync Details</summary>
                        <pre class="debug-json">${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `;
            }
            
            resultMessages.innerHTML = `
                <div class="result-message success">
                    ${message}
                    ${dataHTML}
                </div>
            `;
        }

        // Show error message
        function showError(message) {
            clearMessages();
            const resultMessages = document.getElementById('resultMessages');
            
            resultMessages.innerHTML = `
                <div class="result-message error">
                    ${message}
                </div>
            `;
        }

        // Clear messages
        function clearMessages() {
            const resultMessages = document.getElementById('resultMessages');
            resultMessages.innerHTML = '';
        }
    </script>
            </div>
        </div>
    </div>
</body>
</html>
